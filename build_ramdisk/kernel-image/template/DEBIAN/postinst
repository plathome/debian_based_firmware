#!/bin/sh
# preinst script for easyblockssync
#
# see: dh_installdeb(1)

#set -e

. /etc/default/openblocks

case "$1" in
configure)
	[ -f /.chroot ] && exit 0
	if [ -e /etc/init.d/easyblockssync ] ; then
		/sbin/insserv -d kernel-image
		/etc/init.d/kernel-image start
	elif [ -f /etc/uImage.initrd ] ; then
		if /usr/sbin/flashcfg -y -f /etc/uImage.initrd; then
			rm -f /etc/uImage.initrd
		else
			exit 1
		fi
	elif [ -e /etc/bzImage ] ; then
		if /bin/bash /etc/flashcfg.sh -y -f /etc; then
			rm -f /etc/bzImage
			rm -f /etc/ramdisk*.img.gz /etc/initrd.gz
			rm -f /etc/flashcfg.sh
			rm -f /etc/MD5.*
			rm -f /etc/obstools*
			rm -f /etc/modules.tgz
			rm -f /etc/obsvx2-rootfs* /etc/obsbx1s-rootfs* /etc/obsgem1-rootfs*
			if [ -d /etc/grub.cfg ]; then
				rm -rf /etc/grub.cfg
			fi
			if [ -e /etc/update_ubootenv.sh ];then
				ln -sf /etc/fw_printenv /etc/fw_setenv
				PATH=/etc:$PATH /bin/sh /etc/update_ubootenv.sh -a
				rm -f /etc/update_ubootenv.sh
				rm -f /etc/fw_setenv
				rm -f /etc/fw_printenv
				rm -f /etc/fw_env.config
			fi
		else
			exit 1
		fi
	elif [ -e /etc/Image ] ; then
		if /bin/bash /etc/flashcfg.sh -y -f /etc; then
			rm -f /etc/Image
			rm -f /etc/flashcfg.sh
			rm -f /etc/MD5.*
			rm -f /etc/modules.tgz
			rm -f /etc/obsa16-rootfs*
			rm -f /etc/obsfx0-rootfs*
			rm -f /etc/obsfx1-rootfs*
			rm -f /etc/obsgx4-rootfs*
			rm -f /etc/obsduo-rootfs*
			rm -f /etc/uImage.initrd.*
			rm -f /etc/initrd
			if [ -e /etc/update_ubootenv.sh ];then
				PATH=/etc:$PATH /bin/sh /etc/update_ubootenv.sh -a
			fi
		else
			exit 1
		fi
	elif [ -e /etc/boot.img ] ; then
		if /bin/bash /etc/flashcfg.sh -y -f /etc; then
			rm -f /etc/boot.img
			rm -f /etc/flashcfg.sh
			rm -f /etc/MD5.*
			rm -f /etc/modules.tgz
			rm -f /etc/bootfs.tgz
			rm -f /etc/obstb3n-rootfs*
			if [ -e /etc/update_ubootenv.sh ];then
				PATH=/etc:$PATH /bin/sh /etc/update_ubootenv.sh -a
			fi
		else
			exit 1
		fi
	fi
	if [ -e /etc/rc2.d/S02power-saving.sh ]; then
		/sbin/insserv -rf power-saving.sh
	fi
	if grep -q "^9" /etc/debian_version ; then
		if [ ! -e /etc/rc2.d/S02disable-modem ]; then
			/sbin/insserv -rf disable-modem
			/sbin/insserv disable-modem
		fi
	fi

	if [ -e /etc/udev/rules.d/50-obsvx1-symlink-ttyMODEM.rules -o \
		-e /etc/udev/rules.d/50-obsbx1-symlink-ttyMODEM.rules ]; then
		if [ -e /etc/udev/rules.d/50-symlink-ttyusb-ttyacm.rules ]; then
			rm -f /etc/udev/rules.d/50-symlink-ttyusb-ttyacm.rules
		fi
	fi

	if [ "$MODEL" = "obsbx1" -o "$MODEL" = "obsbx1s" ]; then
		udev_rules=/etc/udev/rules.d/40-rename-ttyrs485.rules
		if [ -e $udev_rules ]; then
			cp $udev_rules $udev_rules.tmp
			sed -e 's/\"1-1.5\"/\"1-1.5:1.0\"/' $udev_rules.tmp > $udev_rules
			rm $udev_rules.tmp
		fi
	fi

	if [ "$MODEL" = "obsfx1" -o "$MODEL" = "obsvx2" ]; then
		udev_rules=/etc/udev/rules.d/30-rename-ttyex2.rules
		if [ -e $udev_rules ]; then
			cp $udev_rules $udev_rules.tmp
			sed -e 's/SUBSYSTEMS==\"usb\", SYMLINK/SUBSYSTEMS==\"usb\", SUBSYSTEM==\"tty\", SYMLINK/' $udev_rules.tmp > $udev_rules
			rm $udev_rules.tmp
		fi
	fi

	if [ "$MODEL" = "obsvx2" ]; then
		udev_rules=/etc/udev/rules.d/40-rename-ttyrs485.rules
		if [ -e $udev_rules ]; then
			cp $udev_rules $udev_rules.tmp
			sed -e 's/SUBSYSTEMS==\"usb\", SYMLINK/SUBSYSTEMS==\"usb\", SUBSYSTEM==\"tty\", SYMLINK/' $udev_rules.tmp > $udev_rules
			rm $udev_rules.tmp
		fi
	fi
;;

abort-upgrade|abort-remove|abort-deconfigure)
;;

*)
echo "postinst called with unknown argument \`$1'" >&2
exit 1
;;
esac



# dh_installdeb will replace this with shell code automatically
# generated by other debhelper scripts.

#DEBHELPER#

exit 0
